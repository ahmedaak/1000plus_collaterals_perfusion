---
title: "1000plus collateral flow & perfusion project (Kersten Villringer)"
author: "Ahmed Khalil"
date: "21 May 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# necessary packages
library(robustbase)
library(knitr)
library(xtable)
library(Hmisc)
library(TOSTER)
library(stargazer)

# load data
allpts <- read.table("Carmela_Project.csv", header = T, sep=",")
colnames(allpts)[1] <- "ID"

# load HIR data
HIR_pts <- read.table("HIR_allpts_AK_20180525.csv", header = T, sep=";")
HIR_pts <- HIR_pts[,c(1,10,11)]

# merge HIR and other data
#allpts <- merge(allpts, HIR_pts, by = "ID")

# create necessary variables (reperfusion / infarct growth binarized cut-offs)
allpts$reperf[allpts$relTmax_change<=-50] <- "Yes"
allpts$reperf[allpts$relTmax_change>-50] <- "No"
allpts$reperf <- factor(allpts$reperf)

allpts$infarct_growth[allpts$DWIgrowth>=7] <- "Yes"
allpts$infarct_growth[allpts$DWIgrowth<7] <- "No"
allpts$infarct_growth <- factor(allpts$infarct_growth)

# recode recanalization variable
allpts$Rekan[allpts$Rekan==0] <- "None" # no recanalization
allpts$Rekan[allpts$Rekan==1] <- "Full" # full recanalization
allpts$Rekan[allpts$Rekan==2] <- "Partial" # partial recanalization
allpts$Rekan <- factor(allpts$Rekan)


# recode other categorical variables
allpts$sex[allpts$sex==1] <- "Male"
allpts$sex[allpts$sex==2] <- "Female"
allpts$sex <- factor(allpts$sex)

allpts$iv_tPR[allpts$iv_tPR==0] <- "No"
allpts$iv_tPR[allpts$iv_tPR==1] <- "Yes"
allpts$iv_tPR <- factor(allpts$iv_tPR)

allpts$circulation[allpts$circulation==1] <- "Anterior"
allpts$circulation[allpts$circulation==2] <- "Posterior"
allpts$circulation <- factor(allpts$circulation)

# remove certain variables
allpts$no_recan_1 <- c()
allpts$VAR00002 <- c()
allpts$TSI_dich <- c()
```

### Descriptive statistics
```{r, echo= FALSE, fig.width=6, fig.height=6, fig.align='center',dpi=300, warning=F}
# descriptive stats
describe(allpts[,-1])
```


### (1.) How many patients with reperfusion are recanalizers or non-recanalizers and (2.) is there a difference in reperfusion status between the groups?
```{r, echo= FALSE, fig.width=6, fig.height=6, fig.align='center',dpi=300, warning=F}
# cross-tabulation of recanalization/reperfusion
kable(table(allpts$reperf, allpts$Rekan))
barplot(table(allpts$reperf, allpts$Rekan), legend.text = c("No reperfusion", "Reperfusion"), col=c("#1b9e77","#d95f02"), xlab="Recanalization", ylab="% of patients", xpd=F,args.legend = list(x = "topleft"), ylim=c(0,80))

# test for differences between recanalization and reperfusion
print(chisq.test(table(allpts$reperf, allpts$Rekan)))

```
There is a statistically significant difference in reperfusion between the recanalization groups (i.e. reperfusion is dependent on recanalization grade).

### Performing ANCOVA (! assumptions violated)
```{r, echo= FALSE, fig.width=6, fig.height=6, fig.align='center',dpi=300, warning=F, eval=F}
# check assumptions of ANCOVA
par(mfrow=c(2,2))
plot(lm(allpts$relTmax_change~allpts$Rekan + allpts$circulation + allpts$TSI + allpts$iv_tPR))

# perform ANCOVA
summary(lm(allpts$relTmax_change~allpts$Rekan + allpts$circulation + allpts$TSI + allpts$iv_tPR))
```

### (3.) Is there a difference in perfusion changes between patients with anterior and posterior circulation strokes?
```{r, echo= FALSE, fig.width=6, fig.height=6, fig.align='center',dpi=300, warning=F, results="asis"}

# test if circulation has influence on reperfusion in non-recanalizers
model_1 <- lmrob(allpts[allpts$Rekan=="None",]$relTmax_change~allpts[allpts$Rekan=="None",]$circulation)
# test if circulation has influence on reperfusion in non-recanalizers ADNJUSTING FOR iv TPA
model_2 <- lmrob(allpts[allpts$Rekan=="None",]$relTmax_change~allpts[allpts$Rekan=="None",]$circulation*allpts[allpts$Rekan=="None",]$iv_tPR)
# test if circulation has influence on reperfusion in recanalizers (full OR partial)
model_3 <- lmrob(allpts[allpts$Rekan=="Full"|allpts$Rekan=="Partial",]$relTmax_change~allpts[allpts$Rekan=="Full"|allpts$Rekan=="Partial",]$circulation)

stargazer(model_1, model_2, model_3, type="html", align = F, style="all", single.row=T)


```

### (4.) Is there an influence of rTPA, TOO, recanalization on perfusion changes?
```{r, echo= FALSE, fig.width=6, fig.height=9, fig.align='center',dpi=300, warning=F, results="asis"}
# check assumptions of robust GLM
par(mfrow=c(3,2))
plot(lmrob(allpts$relTmax_change~allpts$Rekan + allpts$circulation + allpts$TSI + allpts$iv_tPR))

# perform robust GLM
model_4 <- lmrob(allpts$relTmax_change~allpts$Rekan + allpts$circulation + allpts$TSI + allpts$iv_tPR)

par(mfrow=c(1,1))
boxplot(relTmax_change~Rekan, data=allpts, col=c("#1b9e77","#1b9e77"), ylab="Relative Tmax change")

stargazer(model_4, type="html", align = F, style="all", single.row=T)
```

### (5.) Is there a difference in clinical outcome (mRS day90) in reperfused vs non-reperfused recanalizers and non-recanalizers?
```{r, echo= FALSE, fig.width=8, fig.height=6, fig.align='center',dpi=300, warning=F, results="asis"}
# perform robust GLM
model_5 <- lmrob(allpts$mRS_d90~allpts$Rekan*allpts$reperf + allpts$NIHSS_ad + allpts$iv_tPR +allpts$TSI + allpts$rel_DWIgrowth + allpts$mismatch_vol)

stargazer(model_5, type="html", align = F, style="all", single.row=T)

boxplot(mRS_d90~Rekan + reperf, data=allpts, col=c("#1b9e77","#1b9e77","#1b9e77","#d95f02","#d95f02","#d95f02"), ylab="mRS day 90")
legend("topleft", legend = c("Non-reperfused","Reperfused"), fill=c("#1b9e77","#d95f02"))
```

### (6.) Is there a difference in imaging outcome (infarct growth) in reperfused vs non-reperfused recanalizers and non-recanalizers?
```{r, echo= FALSE, fig.width=8, fig.height=6, fig.align='center',dpi=300, warning=F, results="asis"}
# perform robust GLM
model_6 <- lmrob(allpts$rel_DWIgrowth~allpts$Rekan*allpts$reperf + allpts$NIHSS_ad + allpts$iv_tPR +allpts$TSI + allpts$mismatch_vol)

stargazer(model_6, type="html", align = F, style="all", single.row=T)

boxplot(rel_DWIgrowth~Rekan + reperf, data=allpts,col=c("#1b9e77","#1b9e77","#1b9e77","#d95f02","#d95f02","#d95f02"), ylab="Relative DWI growth", ylim=c(-100,300))
legend("topleft", legend = c("Non-reperfused","Reperfused"), fill=c("#1b9e77","#d95f02"))

model_7 <- lmrob(allpts$DWIgrowth~allpts$Rekan*allpts$reperf + allpts$NIHSS_ad + allpts$iv_tPR +allpts$TSI + allpts$mismatch_vol)

stargazer(model_7, type="html", align = F, style="all", single.row=T)

boxplot(DWIgrowth~Rekan + reperf, data=allpts,col=c("#1b9e77","#1b9e77","#1b9e77","#d95f02","#d95f02","#d95f02"), ylab="Absolute DWI growth", ylim=c(0,100))
legend("topleft", legend = c("Non-reperfused","Reperfused"), fill=c("#1b9e77","#d95f02"))

```

### Is reperfusion associated with less infarct growth in non-recanalizers?
```{r, echo= FALSE, fig.width=8, fig.height=6, fig.align='center',dpi=300, warning=F}
# choose non-recanalizers
nonrecan <- allpts[allpts$Rekan=="None",]
# choose non-recanalizers with reperfusion
nonrecan_reperf <- nonrecan[nonrecan$reperf=="Yes",]
# choose non-recanalizers with no reperfusion
nonrecan_noreperf <- nonrecan[nonrecan$reperf=="No",]

# boxplot of DWI growth in reperfusers vs non-reperfusers
boxplot(nonrecan_noreperf$DWIgrowth, nonrecan_reperf$DWIgrowth, ylab = "Absolute DWI growth (mL)")
wilcox.test(nonrecan_noreperf$DWIgrowth, nonrecan_reperf$DWIgrowth)
TOSTtwo(m1 = mean(nonrecan_noreperf$DWIgrowth), m2 = mean(nonrecan_reperf$DWIgrowth), sd(nonrecan_noreperf$DWIgrowth), sd(nonrecan_reperf$DWIgrowth), n1 = length(nonrecan_noreperf$DWIgrowth), n2 = length(nonrecan_reperf$DWIgrowth), low_eqbound_d = -0.6, high_eqbound_d = 0.6)

boxplot(nonrecan_noreperf$rel_DWIgrowth, nonrecan_reperf$rel_DWIgrowth, ylab = "Relative DWI growth (%)")
wilcox.test(nonrecan_noreperf$rel_DWIgrowth, nonrecan_reperf$rel_DWIgrowth)
TOSTtwo(m1 = mean(nonrecan_noreperf$rel_DWIgrowth), m2 = mean(nonrecan_reperf$rel_DWIgrowth), sd(nonrecan_noreperf$rel_DWIgrowth), sd(nonrecan_reperf$rel_DWIgrowth), n1 = length(nonrecan_noreperf$rel_DWIgrowth), n2 = length(nonrecan_reperf$rel_DWIgrowth), low_eqbound_d = -0.6, high_eqbound_d = 0.6)


# crosstab of reperfusion vs infarct growth
kable(table(nonrecan$reperf, nonrecan$infarct_growth))


# barplot of reperfusion vs infarct growth
barplot(table(nonrecan$reperf, nonrecan$infarct_growth),legend.text = c("No infarct growth", "Infarct growth"), col=c("#1b9e77","#d95f02"), xlab="Reperfusion", ylab="Number of patients", xpd=F,args.legend = list(x = "topright"), ylim=c(0,40))

# test for differences between reperfusion and infarct growth
print(chisq.test(table(allpts$reperf, allpts$infarct_growth)))

```